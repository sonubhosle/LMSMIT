<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Library Management System</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

</head>

<body class="h-full bg-slate-50">

    <!-- Loader -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
            </div>
            <p class="text-slate-600">Loading Dashboard...</p>
        </div>
    </div>

    <div class="flex h-full">

        <!-- SIDEBAR -->
        <div>
            <div
                class="h-[100vh] fixed top-0 bg-white  w-70 border border-slate-200 z-40 sidebar-scrollbar overflow-y-auto">
                <!-- User -->
                <div class="p-6 border-b border-slate-200 flex gap-4">
                    <i
                        class='bx bx-user text-[22px] bg-gradient-to-r from-emerald-500 to-emerald-700  rounded-3xl p-3 text-white flex items-center justify-center text-purple-600'></i>
                    <div class="">
                        <h3 id="userName" class="font-medium">Loading...</h3>
                        <p id="userEmail" class="text-emerald-500 text-sm">Loading...</p>
                    </div>
                </div>

                <!-- Menu -->
                <nav class="p-4 space-y-1">
                    <a href="#" data-page="dashboard"
                        class="sidebar-item block p-3 font-semibold rounded-xl text-slate-600  transition ease-in duration-300 ">
                        <i class="fas fa-tachometer-alt text-lg w-6 text-center"></i>
                        Dashboard
                    </a>
                    <a href="#" data-page="students"
                        class="sidebar-item block p-3 font-semibold rounded-xl  text-slate-600  transition ease-in duration-300">
                        <i class="fas fa-user-graduate text-lg w-6 text-center"></i>
                        Students
                    </a>
                    <a href="#" data-page="books"
                        class="sidebar-item block p-3 font-semibold rounded-xl text-slate-600 transition ease-in duration-300">
                        <i class="fas fa-book text-lg w-6 text-center"></i>
                        Books
                    </a>
                    <a href="#" data-page="issues"
                        class="sidebar-item block p-3 font-semibold rounded-xl text-slate-600  transition ease-in duration-300">
                        <i class="fas fa-exchange-alt text-lg w-6 text-center"></i>
                        Issued Books</a>
                    <a href="#" data-page="invoices"
                        class="sidebar-item block p-3 font-semibold rounded-xl text-slate-600  transition ease-in duration-300">
                        <i class="fas fa-file-invoice-dollar text-lg w-6 text-center"></i>
                        Invoices</a>
                </nav>

                <!-- Logout -->
                <div class="p-6 border-t absolute left-0 bottom-0 w-full border-slate-200 ">
                    <button id="logoutBtn"
                        class="w-full p-3 text-white bg-gradient-to-r from-rose-500 to-rose-700 rounded-lg">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="w-full ml-72 py-6 pr-6 overflow-y-auto h-[100vh] content-scrollbar">
            <div id="pageContent"></div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/students.js"></script>
    <script src="js/books.js"></script>
    <script src="js/issues.js"></script>
    <script src="js/invoices.js"></script>

    <script>


        // Global API utility
        const api = {
            async fetch(url, options = {}) {
                const token = localStorage.getItem('token');

                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    // Handle unauthorized (401) - redirect to login
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('librarian');
                        window.location.href = 'login.html';
                        return response;
                    }

                    return response;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            }
        };

        // Make api available globally
        window.api = api;

        /* ======================
           DASHBOARD INITIALIZATION
        ====================== */
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const token = localStorage.getItem('token');
            const librarian = localStorage.getItem('librarian');

            if (!token || !librarian) {
                window.location.href = 'login.html';
                return;
            }

            // Hide loader
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 500);

            // Load user info
            const userData = JSON.parse(librarian);
            if (userData) {
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userEmail').textContent = userData.email;
            }

            // Setup navigation
            setupNavigation();

            // Load default page (dashboard)
            await loadPage('dashboard');

            // Highlight active sidebar item
            highlightActiveSidebar();
        });

        /* ======================
           NAVIGATION SYSTEM
        ====================== */
        function setupNavigation() {
            // Get all sidebar links
            const sidebarLinks = document.querySelectorAll('.sidebar-item');

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.currentTarget.getAttribute('data-page');
                    loadPage(page);
                    highlightActiveSidebar(e.currentTarget);
                });
            });
        }

        function highlightActiveSidebar(activeElement = null) {
            // Remove active class from all items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                item.classList.remove('text-emerald-600',);
            });

            // Add active class to clicked element or find current
            if (activeElement) {
                activeElement.classList.add('active');
                activeElement.classList.add('text-emerald-600');
            } else {
                // Find based on current page
                const currentPage = getCurrentPage();
                const currentLink = document.querySelector(`[data-page="${currentPage}"]`);
                if (currentLink) {
                    currentLink.classList.add('active');
                    currentLink.classList.add('text-emerald-600');
                }
            }
        }

        function getCurrentPage() {
            const content = document.getElementById('pageContent');
            if (!content) return 'dashboard';

            const page = content.getAttribute('data-current-page');
            return page || 'dashboard';
        }

        /* ======================
           PAGE LOADER
        ====================== */
        /* ======================
           PAGE LOADER - SIMPLIFIED VERSION
        ====================== */
        async function loadPage(pageName) {
            const content = document.getElementById('pageContent');

            console.log(`Loading page: ${pageName}`);

            // Show loading state
            content.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12">
            <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-slate-600">Loading ${pageName}...</p>
        </div>
    `;

            try {
                switch (pageName) {
                    case 'dashboard':
                        // Load dashboard content
                        content.innerHTML = await loadDashboardContent();
                        // Initialize dashboard functionality
                        if (typeof initializeDashboard === 'function') {
                            console.log('Initializing dashboard...');
                            await initializeDashboard();
                        }
                        break;

                    case 'students':
                        console.log('Loading students page...');
                        if (typeof loadStudentsPage === 'function') {
                            // Clear content first
                            content.innerHTML = '';
                            content.setAttribute('data-current-page', pageName);

                            // Call the function
                            await loadStudentsPage();
                            console.log('Students page loaded successfully');
                        } else {
                            throw new Error('loadStudentsPage function not available');
                        }
                        break;

                    case 'books':
                        console.log('Loading books page...');
                        if (typeof loadBooksPage === 'function') {
                            content.innerHTML = '';
                            content.setAttribute('data-current-page', pageName);
                            await loadBooksPage();
                            console.log('Books page loaded successfully');
                        } else {
                            throw new Error('loadBooksPage function not available');
                        }
                        break;

                    case 'issues':
                        console.log('Loading issues page...');
                        if (typeof loadIssuesPage === 'function') {
                            content.innerHTML = '';
                            content.setAttribute('data-current-page', pageName);
                            await loadIssuesPage();
                            console.log('Issues page loaded successfully');
                        } else {
                            throw new Error('loadIssuesPage function not available');
                        }
                        break;

                    case 'invoices':
                        console.log('Loading invoices page...');
                        if (typeof loadInvoicesPage === 'function') {
                            content.innerHTML = '';
                            content.setAttribute('data-current-page', pageName);
                            await loadInvoicesPage();
                            console.log('Invoices page loaded successfully');
                        } else {
                            throw new Error('loadInvoicesPage function not available');
                        }
                        break;

                    default:
                        content.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Page Not Found</h2>
                        <p class="text-slate-600">The requested page "${pageName}" doesn't exist.</p>
                    </div>
                `;
                }

            } catch (error) {
                console.error(`Error loading ${pageName}:`, error);
                content.innerHTML = `
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">Error Loading Page</h2>
                <p class="text-slate-600">${error.message}</p>
                <div class="mt-4 space-x-2">
                    <button onclick="loadPage('${pageName}')" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition duration-200">
                        Retry
                    </button>
                    <button onclick="loadPage('dashboard')" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition duration-200">
                        Back to Dashboard
                    </button>
                </div>
            </div>
        `;
            }
        }
        /* ======================
           DASHBOARD CONTENT
        ====================== */
        async function loadDashboardContent() {
            // First, try to get stats
            let stats = {
                books: 0,
                students: 0,
                issuedBooks: 0,
                invoices: 0,
                overdueBooks: 0,
                totalRevenue: 0,
                pendingInvoices: 0
            };

            try {
                // Get books stats
                const booksResponse = await api.fetch('http://localhost:5000/api/books/stats/summary');
                if (booksResponse.ok) {
                    const booksData = await booksResponse.json();
                    stats.books = booksData.stats.totalBooks;
                }

                // Get students count
                const studentsResponse = await api.fetch('http://localhost:5000/api/students?limit=1');
                if (studentsResponse.ok) {
                    const studentsData = await studentsResponse.json();
                    stats.students = studentsData.total;
                }

                // Get issues stats
                const issuesResponse = await api.fetch('http://localhost:5000/api/issues/stats/summary');
                if (issuesResponse.ok) {
                    const issuesData = await issuesResponse.json();
                    stats.issuedBooks = issuesData.stats.totalIssued;
                    stats.overdueBooks = issuesData.stats.totalOverdue;
                }

                // Get invoices stats
                const invoicesResponse = await api.fetch('http://localhost:5000/api/invoices/stats/summary');
                if (invoicesResponse.ok) {
                    const invoicesData = await invoicesResponse.json();
                    stats.invoices = invoicesData.stats.totalInvoices;
                    stats.totalRevenue = invoicesData.stats.totalRevenue;
                    stats.pendingInvoices = invoicesData.stats.pendingInvoices;
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }

            return `
        <div class="animate-fade-in">
            <!-- Welcome Header -->
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">Welcome back!</h1>
                    <p class="text-slate-600 mt-1">Library Dashboard.</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <div class="text-sm text-slate-500">Current Date</div>
                    <div class="text-lg font-semibold text-slate-800">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Books -->
                <div class="group cursor-pointer bg-white rounded-xl relative overflow-hidden  border border-slate-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Total Books</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="totalBooks">${stats.books.toLocaleString()}</h3>
                            <p class="text-sm text-slate-500 mt-2">Available: <span id="availableBooks">Loading...</span></p>
                        </div>

                        <div class="absolute w-48 h-48 -right-20 -top-20 rounded-full bg-gradient-to-r from-indigo-50 to-indigo-100 
                        group-hover:from-indigo-400 group-hover:to-indigo-500 transition ease-in duration-300  flex items-center ">
                            <i class="fas fa-book text-indigo-500 text-2xl  pl-12 pt-16 z-100 group-hover:text-white  transition ease-in duration-300"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Total Students -->
                <div class="group cursor-pointer bg-white relative overflow-hidden rounded-xl  border border-slate-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Total Students</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="totalStudents">${stats.students.toLocaleString()}</h3>
                            <p class="text-sm text-slate-500 mt-2">Active: <span id="activeStudents">Loading...</span></p>
                        </div>
                      
                        <div class="absolute w-48 h-48 -right-20 -top-20 rounded-full bg-gradient-to-r from-emerald-50 to-emerald-100 
                        group-hover:from-emerald-400 group-hover:to-emerald-500 transition ease-in duration-300  flex items-center ">
                            <i class="fas fa-users text-emerald-500 text-2xl  pl-12 pt-16 z-100 group-hover:text-white  transition ease-in duration-300"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Issued Books -->
                <div class="bg-white cursor-pointer group relative rounded-xl overflow-hidden  border border-slate-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Issued Books</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="issuedBooks">${stats.issuedBooks.toLocaleString()}</h3>
                            <p class="text-sm text-slate-500 mt-2">Overdue: <span id="overdueBooks">${stats.overdueBooks.toLocaleString()}</span></p>
                        </div>
                         <div class="absolute w-48 h-48 -right-20 -top-20 rounded-full bg-gradient-to-r from-purple-50 to-purple-100 
                        group-hover:from-purple-400 group-hover:to-purple-500 transition ease-in duration-300  flex items-center ">
                            <i class="fas fa-exchange-alt text-purple-500 text-2xl  pl-12 pt-16 z-100 group-hover:text-white  transition ease-in duration-300"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Total Invoices -->
                <div class="bg-white cursor-pointer group relative rounded-xl overflow-hidden border border-slate-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Total Invoices</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="totalInvoices">${stats.invoices.toLocaleString()}</h3>
                            <p class="text-sm text-slate-500 mt-2">Revenue: ₹<span id="totalRevenue">${stats.totalRevenue.toLocaleString('en-IN')}</span></p>
                        </div>
                      
                         <div class="absolute w-48 h-48 -right-20 -top-20 rounded-full bg-gradient-to-r from-amber-50 to-amber-100 
                        group-hover:from-amber-400 group-hover:to-amber-500 transition ease-in duration-300  flex items-center ">
                            <i class="fas fa-file-invoice-dollar text-amber-500 text-2xl  pl-12 pt-16 z-100 group-hover:text-white  transition ease-in duration-300"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recent Issues -->
                <div class="bg-white rounded-xl  border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-slate-800">Recent Issues</h2>
                            <button onclick="loadPage('issues')" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium">
                                View All →
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="recentIssues" class="space-y-4">
                            <div class="flex flex-col items-center justify-center py-8">
                                <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                <p class="text-slate-600">Loading recent issues...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Overdue Books -->
                <div class="bg-white rounded-xl  border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-slate-800">Overdue Books</h2>
                            <span class="px-3 py-1 bg-red-100 text-red-800 text-sm font-medium rounded-full" id="overdueCount">${stats.overdueBooks}</span>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="overdueList" class="space-y-4">
                            ${stats.overdueBooks === 0 ? `
                                <div class="text-center py-8">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-check text-green-600 text-xl"></i>
                                    </div>
                                    <p class="text-slate-600">No overdue books! Great work!</p>
                                </div>
                            ` : `
                                <div class="flex flex-col items-center justify-center py-8">
                                    <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                    <p class="text-slate-600">Loading overdue books...</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <!-- Recent Students -->
                <div class="bg-white rounded-xl  border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-slate-800">Recent Students</h2>
                            <button onclick="loadPage('students')" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium">
                                View All →
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="recentStudents" class="space-y-4">
                            <div class="flex flex-col items-center justify-center py-8">
                                <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                <p class="text-slate-600">Loading recent students...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Invoices -->
                <div class="bg-white rounded-xl  border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-slate-800">Recent Invoices</h2>
                            <button onclick="loadPage('invoices')" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium">
                                View All →
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="recentInvoices" class="space-y-4">
                            <div class="flex flex-col items-center justify-center py-8">
                                <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                <p class="text-slate-600">Loading recent invoices...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
        }

        /* ======================
           LOGOUT FUNCTION
        ====================== */
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('librarian');

            if (window.electronAPI && window.electronAPI.navigateTo) {
                window.electronAPI.navigateTo('login');
            } else {
                window.location.href = 'login.html';
            }
        });

        /* ======================
           TOAST CONTAINER
        ====================== */
        // Create toast container if it doesn't exist
        if (!document.getElementById('toastContainer')) {
            const toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'fixed top-4 right-4 z-50 space-y-2';
            document.body.appendChild(toastContainer);
        }
    </script>